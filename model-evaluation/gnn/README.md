Code for running the GNN is made available on GitHub as part of the survey paper from 
Marcelli et. al, *How Machine Learning Is Solving the Binary Function Similarity Problem*.
The accompanying code can be found 
[here](https://github.com/Cisco-Talos/binary_function_similarity/tree/main/Models/GGSNN-GMN),
and comes with a descriptive README. Our code (and documentation) is intended to complement, not
replace, that work. Therefore, we only provide and discuss our supplemental code for extending
the GNN to return the function embeddings it produces. Readers should also familiarize themselves 
with the original repository before running our experiments.

# Using the GNN to generate function embeddings

0. Clone the Marcelli GitHub repository: *git clone https://github.com/Cisco-Talos/binary_function_similarity.git*

1. Integrate our supplemental code:
       	          
    1. Replace *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/gnn.py* with our custom
       *gnn.py* file. Our file adds support for using the GNN to generate and save embeddings,
       without any downstream evaluation. It also adds support for testing on our new datasets.
       
    2. Replace *config.py*, *build_model.py*, and *gnn_model.py* in 
	   *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/core* with our custom files.
       *build_model.py* and *gnn_model.py* add support for returning and saving the embeddings
       generated by the model. *config.py* adds new configuration options to support testing
       on our additional datasets.
       
    3. Add *graph_factory_embeddings.py* to *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/core*.
       This file contains a custom dataloader that passes each function to the model once, to 
       generate an embedding. This is in contrast to the pair and triplet loaders provided in the 
       original repository.
       
    4. Add the directory *refuse-public/model-training/checkpoints/gnn_assemblage_checkpoint_1*  
       to *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork*. This is the checkpoint
       of the GNN trained on Assemblage data.

    5. Add the line *COPY gnn_assemblage_checkpoint_1/ /code/gnn_assemblage_checkpoint_1* to the end of
       *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/Dockerfile* to update the docker container.
       You will have to add a similar line for each new checkpoint you wish to evaluate with. 
    
2. Preprocess the data following the instructions in *refuse-public/data-processing/gnn/README.md*. 
      
3. Generate embeddings using the trained GNN model released by Marcelli et. al. Follow the
   instructions in Part 2 of the README in *binary_function_similarity/Models/GGSNN-GMN*. 
   After building the docker image, run the following docker command:
   
   ```
   docker run --rm \
        -v $(pwd)/../../DBs:/input \
        -v $(pwd)/Preprocessing:/preprocessing \
        -v $(pwd)/NeuralNetwork/:/output \
        -it gnn-neuralnetwork /code/gnn.py --embeddings \
            --model_type embedding --training_mode pair \
            --features_type opc --dataset dset \
            -c /code/checkpoint \
            -o /output/Dataset-dset
   ```
   where "dset" is either "motif","commonlibraries", "binarycorp", "assemblagetest", or "one" (for 
   Marcelli Dataset-1). 
   Set checkpoint to *model_checkpoint_GGSNN_pair* to evaluate with the Linux model used by
   Marcelli, or to *gnn_assemblage_checkpoint_1** to evaluate with the GNN trained on 
   Assemblage (Windows) data. The resulting embeddings and labels files will be stored in 
   *binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/Dataset-dset*.
		
**Troubleshooting** 
We have occasionally encountered the following error:
```
tensorflow.python.framework.errors_impl.InvalidArgumentError: data.shape = [1470,128] does not start with segment_ids.shape = [1271]
	 [[{{node graph-embedding-net_3/graph-aggregator/UnsortedSegmentSum}}]]
```
and have found that it can be resolved by replacing line 116 of 
*binary_function_similarity/Models/GGSNN-GMN/NeuralNetwork/core/graph_factory_utils.py* with
`graph_idx.append(np.ones(len(f), dtype=np.int32) * i)`
